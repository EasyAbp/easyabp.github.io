(window.webpackJsonp=window.webpackJsonp||[]).push([[78],{725:function(t,a,e){"use strict";e.r(a);var n=e(73),s=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"wechatmanagement-miniprograms"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#wechatmanagement-miniprograms"}},[t._v("#")]),t._v(" WeChatManagement.MiniPrograms")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://abp.io",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://img.shields.io/badge/dynamic/xml?style=flat-square&color=yellow&label=abp&query=%2F%2FProject%2FPropertyGroup%2FAbpVersion&url=https%3A%2F%2Fraw.githubusercontent.com%2FEasyAbp%2FWeChatManagement%2Fmaster%2FDirectory.Build.props",alt:"ABP version"}}),a("OutboundLink")],1),t._v(" "),a("a",{attrs:{href:"https://www.nuget.org/packages/EasyAbp.WeChatManagement.MiniPrograms.Domain.Shared",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://img.shields.io/nuget/v/EasyAbp.WeChatManagement.MiniPrograms.Domain.Shared.svg?style=flat-square",alt:"小程序模块"}}),a("OutboundLink")],1),t._v(" "),a("a",{attrs:{href:"https://www.nuget.org/packages/EasyAbp.WeChatManagement.MiniPrograms.Domain.Shared",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://img.shields.io/nuget/dt/EasyAbp.WeChatManagement.MiniPrograms.Domain.Shared.svg?style=flat-square",alt:"下载量"}}),a("OutboundLink")],1),t._v(" "),a("a",{attrs:{href:"https://discord.gg/xyg8TrRa27",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://badgen.net/discord/online-members/xyg8TrRa27?label=Discord",alt:"Discord online"}}),a("OutboundLink")],1),t._v(" "),a("a",{attrs:{href:"https://www.github.com/EasyAbp/WeChatManagement",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://img.shields.io/github/stars/EasyAbp/WeChatManagement?style=social",alt:"GitHub stars"}}),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("Abp 小程序管理模块，提供小程序登录、用户个人信息记录、小程序微信服务器等功能，自动适应微信开放平台规则，与微信第三方平台模块轻松衔接。")]),t._v(" "),a("h2",{attrs:{id:"online-demo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#online-demo"}},[t._v("#")]),t._v(" Online Demo")]),t._v(" "),a("p",[t._v("We have launched an online demo for this module: "),a("a",{attrs:{href:"https://wechat.samples.easyabp.io",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://wechat.samples.easyabp.io"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"installation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#installation"}},[t._v("#")]),t._v(" Installation")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("Install the following NuGet packages. ("),a("a",{attrs:{href:"https://github.com/EasyAbp/EasyAbpGuide/blob/master/docs/How-To.md#add-nuget-packages",target:"_blank",rel:"noopener noreferrer"}},[t._v("see how"),a("OutboundLink")],1),t._v(")")]),t._v(" "),a("ul",[a("li",[t._v("EasyAbp.WeChatManagement.MiniPrograms.Application")]),t._v(" "),a("li",[t._v("EasyAbp.WeChatManagement.MiniPrograms.Application.Contracts")]),t._v(" "),a("li",[t._v("(2选1) EasyAbp.WeChatManagement.MiniPrograms.Domain.OpenIddict")]),t._v(" "),a("li",[t._v("(2选1) EasyAbp.WeChatManagement.MiniPrograms.Domain.Ids4")]),t._v(" "),a("li",[t._v("EasyAbp.WeChatManagement.MiniPrograms.Domain.Shared")]),t._v(" "),a("li",[t._v("EasyAbp.WeChatManagement.MiniPrograms.EntityFrameworkCore")]),t._v(" "),a("li",[t._v("EasyAbp.WeChatManagement.MiniPrograms.HttpApi")]),t._v(" "),a("li",[t._v("EasyAbp.WeChatManagement.MiniPrograms.HttpApi.Client")]),t._v(" "),a("li",[t._v("(Optional) EasyAbp.WeChatManagement.MiniPrograms.MongoDB")]),t._v(" "),a("li",[t._v("(Optional) EasyAbp.WeChatManagement.MiniPrograms.Web")]),t._v(" "),a("li",[t._v("(Optional) EasyAbp.Abp.WeChat.Common.SharedCache.StackExchangeRedis ("),a("strong",[t._v("重要！如果开发/沙盒/线上均使用了相同的微信AppId，请安装此模块，使用中立缓存共享 AccessToken: https://github.com/EasyAbp/WeChatManagement/issues/15#issuecomment-769718739")]),t._v(")")])])]),t._v(" "),a("li",[a("p",[t._v("Add "),a("code",[t._v("DependsOn(typeof(WeChatManagementMiniProgramsXxxModule))")]),t._v(" attribute to configure the module dependencies. ("),a("a",{attrs:{href:"https://github.com/EasyAbp/EasyAbpGuide/blob/master/docs/How-To.md#add-module-dependencies",target:"_blank",rel:"noopener noreferrer"}},[t._v("see how"),a("OutboundLink")],1),t._v(")")])]),t._v(" "),a("li",[a("p",[t._v("Add "),a("code",[t._v("builder.ConfigureWeChatManagementCommon();")]),t._v(" and "),a("code",[t._v("builder.ConfigureWeChatManagementMiniPrograms();")]),t._v(" to the "),a("code",[t._v("OnModelCreating()")]),t._v(" method in "),a("strong",[t._v("MyProjectMigrationsDbContext.cs")]),t._v(".")])]),t._v(" "),a("li",[a("p",[t._v("Add EF Core migrations and update your database. See: "),a("a",{attrs:{href:"https://docs.abp.io/en/abp/latest/Tutorials/Part-1?UI=MVC&DB=EF#add-database-migration",target:"_blank",rel:"noopener noreferrer"}},[t._v("ABP document"),a("OutboundLink")],1),t._v(".")])]),t._v(" "),a("li",[a("p",[t._v("在 Web/Host 项目的 appsettings.json 中增加微信登录授权服务器配置：")]),t._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"WeChatManagement"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"MiniPrograms"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"AuthServer"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Authority"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://localhost:44380"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"ClientId"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MyProjectName_WeChatMiniProgram"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"ClientSecret"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1q2w3e*"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("在 OpenIddictDataSeedContributor 中增加新的客户端 Data Seed (你也可以使用 "),a("a",{attrs:{href:"https://github.com/EasyAbp/WeChatManagement/blob/master/samples/WeChatManagementSample/aspnet-core/src/WeChatManagementSample.Domain/IdentityServer/IdentityServerDataSeedContributor.cs",target:"_blank",rel:"noopener noreferrer"}},[t._v("IDS4"),a("OutboundLink")],1),t._v(")：")]),t._v(" "),a("div",{staticClass:"language-CSharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// WeChat MiniProgram")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")])]),t._v(" weChatMiniProgramClientId "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n    configurationSection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MyProjectName_WeChatMiniProgram:ClientId"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("weChatMiniProgramClientId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("IsNullOrWhiteSpace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("CreateClientAsync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        weChatMiniProgramClientId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        commonScopes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"refresh_token"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" WeChatMiniProgramConsts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("GrantType "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("configurationSection"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MyProjectName_WeChatMiniProgram:ClientSecret"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("??")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1q2w3e*"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Sha256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("在 DbMigrator 项目的 appsettings.json 中增加：")]),t._v(" "),a("div",{staticClass:"language-CSharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"IdentityServer"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Clients"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"WeChatManagementSample_WeChatMiniProgram"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ClientId"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"MyProjectName_WeChatMiniProgram"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ClientSecret"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1q2w3e*"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("运行 DbMigrator 项目，以创建新的授权客户端。")])])]),t._v(" "),a("h2",{attrs:{id:"usage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#usage"}},[t._v("#")]),t._v(" Usage")]),t._v(" "),a("h3",{attrs:{id:"小程序登录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小程序登录"}},[t._v("#")]),t._v(" 小程序登录")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("使用 "),a("code",[t._v("/api/wechat-management/mini-programs/login/login")]),t._v(" (POST) 接口进行微信登录，留意 "),a("a",{attrs:{href:"https://github.com/EasyAbp/WeChatManagement/blob/master/modules/MiniPrograms/src/EasyAbp.WeChatManagement.MiniPrograms.Application.Contracts/EasyAbp/WeChatManagement/MiniPrograms/Login/Dtos/LoginInput.cs",target:"_blank",rel:"noopener noreferrer"}},[t._v("LoginInput"),a("OutboundLink")],1),t._v(" 的注释说明。")])]),t._v(" "),a("li",[a("p",[t._v("使用 "),a("code",[t._v("/api/wechat-management/mini-programs/login/refresh")]),t._v(" (POST) 接口对 AccessToken 续期。")])]),t._v(" "),a("li",[a("p",[t._v("在有需要时，使用 "),a("code",[t._v("/api/wechat-management/mini-programs/user-info")]),t._v(" (PUT) 接口对存储的微信用户信息进行更新。(见 https://github.com/EasyAbp/WeChatManagement/issues/20)")])])]),t._v(" "),a("h3",{attrs:{id:"小程序授权-razor-页面登录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小程序授权-razor-页面登录"}},[t._v("#")]),t._v(" 小程序授权 Razor 页面登录")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("配置用于微信登录的小程序的 Name，默认为"),a("code",[t._v("Default")]),t._v("，参考"),a("a",{attrs:{href:"https://github.com/EasyAbp/WeChatManagement/blob/master/modules/MiniPrograms/src/EasyAbp.WeChatManagement.MiniPrograms.Domain/EasyAbp/WeChatManagement/MiniPrograms/Settings/MiniProgramsSettings.cs",target:"_blank",rel:"noopener noreferrer"}},[t._v("本模块设置"),a("OutboundLink")],1),t._v("。")])]),t._v(" "),a("li",[a("p",[t._v("重写登录页，在页面中插入 "),a("a",{attrs:{href:"https://github.com/EasyAbp/WeChatManagement/blob/master/modules/MiniPrograms/src/EasyAbp.WeChatManagement.MiniPrograms.Web/Pages/WeChatManagement/MiniPrograms/Components/WeChatMiniProgramPcLoginWidget/WeChatMiniProgramPcLoginWidgetViewComponent.cs",target:"_blank",rel:"noopener noreferrer"}},[t._v("WeChatMiniProgramPcLoginWidget"),a("OutboundLink")],1),t._v("，重写方法参考 "),a("a",{attrs:{href:"https://docs.abp.io/en/abp/latest/How-To/Customize-Login-Page-MVC",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),a("OutboundLink")],1),t._v(" 和 "),a("a",{attrs:{href:"https://github.com/EasyAbp/WeChatManagement/blob/master/samples/WeChatManagementSample/aspnet-core/src/WeChatManagementSample.Web/Pages/Account",target:"_blank",rel:"noopener noreferrer"}},[t._v("本模块示例"),a("OutboundLink")],1),t._v("。")])]),t._v(" "),a("li",[a("p",[t._v("微信扫码后（默认配置下，会打开小程序首页），确保小程序本身已完成用户登录，小程序需要将扫码获得的 "),a("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/qr-code/wxacode.getUnlimited.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("scene"),a("OutboundLink")],1),t._v(" 作为 token 参数传入 "),a("code",[t._v("/api/wechat-management/mini-programs/login/authorize-pc")]),t._v(" 接口。")])]),t._v(" "),a("li",[a("p",[t._v("完成上一步后，Razor 登录页将自动完成登录并跳转。")])])]),t._v(" "),a("p",[a("img",{attrs:{src:"/modules/WeChatManagement/MiniPrograms/images/MiniProgram.png",alt:"MiniProgram"}}),t._v(" "),a("img",{attrs:{src:"/modules/WeChatManagement/MiniPrograms/images/MiniProgramUser.png",alt:"MiniProgramUser"}}),t._v(" "),a("img",{attrs:{src:"/modules/WeChatManagement/MiniPrograms/images/UserInfo.png",alt:"UserInfo"}}),t._v(" "),a("img",{attrs:{src:"/modules/WeChatManagement/MiniPrograms/images/PcLogin.png",alt:"PcLogin"}})]),t._v(" "),a("h2",{attrs:{id:"roadmap"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#roadmap"}},[t._v("#")]),t._v(" Roadmap")]),t._v(" "),a("ul",[a("li",[t._v("[ ] 微信服务器")]),t._v(" "),a("li",[t._v("[ ] 旧账号关联微信登录")]),t._v(" "),a("li",[t._v("[x] 微信授权 Razor 页面登录")]),t._v(" "),a("li",[t._v("[ ] 对接第三方平台模块")]),t._v(" "),a("li",[t._v("[ ] 单元测试")])])])}),[],!1,null,null,null);a.default=s.exports}}]);